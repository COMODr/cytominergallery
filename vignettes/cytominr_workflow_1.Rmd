---
  title: "Morphological profiling"
author: "Allen Goodman and Shantanu Singh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Morphological profiling}
%\VignetteEngine{knitr::rmarkdown}
%\VignetteEncoding{UTF-8}
---

  Typical morphological profiling datasets have millions of cells
and hundreds of features per cells. When working with this data, you must

- clean the data

- normalize the features so that they are comparable across experiments

- transform the features so that their distributions are well-behaved (
  i.e., bring them in line with assumptions we want to make about their
  disributions)

- select features based on their quality

- aggregate the single-cell data, if needed

The cytominr package makes these steps fast and easy.

## Load data
First, load the data, which is stored in a database backend created using
https://github.com/0x00B1/persistence.

```{r}
library(magrittr)

```

```{r load_data}
db <- dplyr::src_sqlite(path = "~/tmp/az/backend/Week1/Week1.sqlite")

image <- dplyr::tbl(src = db, "Image")

object <-
  dplyr::tbl(src = db, "Cells") %>%
  dplyr::inner_join(dplyr::tbl(src = db, "Cytoplasm"),
                    by = c("TableNumber", "ImageNumber", "ObjectNumber")) %>%
  dplyr::inner_join(dplyr::tbl(src = db, "Nuclei"),
                    by = c("TableNumber", "ImageNumber", "ObjectNumber"))

object %<>% dplyr::inner_join(image, by = c("TableNumber", "ImageNumber"))

feature_cols <-
  colnames(object) %>%
  stringr::str_subset("^Nuclei_|^Cells_|^Cytoplasm_")
```


```{r}
aggregated <-
  cytominr::aggregate(
    population = object,
    variables = feature_cols,
    strata = c("Image_Metadata_Plate", "Image_Metadata_Well"),
    operation = "mean"
  )

plate_count <-
  aggregated %>%
  dplyr::count(Image_Metadata_Plate) %>%
  dplyr::collect()

aggregated %<>%
  dplyr::collect()


```

