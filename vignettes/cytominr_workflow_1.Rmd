---
title: "Morphological profiling"
author: "Allen Goodman and Shantanu Singh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Morphological profiling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Typical morphological profiling datasets have millions of cells
and hundreds of features per cells. When working with this data, you must

- clean the data

- normalize the features so that they are comparable across experiments

- transform the features so that their distributions are well-behaved (
  i.e., bring them in line with assumptions we want to make about their
  disributions)

- select features based on their quality

- aggregate the single-cell data, if needed

The cytominr package makes these steps fast and easy.

This vignette demonstrates how to aggregate single cell measurements and 
store the result. 

## Load data

```{r libraries}
library(magrittr)

```


```{r download, cache=TRUE}
backend <- file.path(tempdir(), "BBBC021.sqlite")

download.file("https://s3.amazonaws.com/imaging-platform-collaborator/2016_09_09_cytominr_workshop/BBBC021.sqlite",
              backend)

```


```{r load}

db <- dplyr::src_sqlite(path = backend)

image <- dplyr::tbl(src = db, "Image")

object <-
  dplyr::tbl(src = db, "Cells") %>%
  dplyr::inner_join(dplyr::tbl(src = db, "Cytoplasm"),
                    by = c("TableNumber", "ImageNumber", "ObjectNumber")) %>%
  dplyr::inner_join(dplyr::tbl(src = db, "Nuclei"),
                    by = c("TableNumber", "ImageNumber", "ObjectNumber"))

object %<>% dplyr::inner_join(image, by = c("TableNumber", "ImageNumber"))

feature_cols <-
  colnames(object) %>%
  stringr::str_subset("^Nuclei_|^Cells_|^Cytoplasm_")
```


## Summarize measurements per well

```{r aggregate}
aggregated <-
  cytominr::aggregate(
    population = object,
    variables = feature_cols,
    strata = c("Image_Metadata_Plate", "Image_Metadata_Well"),
    operation = "mean"
  )

aggregated %<>%
  dplyr::collect()

aggregated %>%
  readr::write_csv("bbbc021_well_profiles.csv")
```

## Plot some data

```{r plot}
library(ggplot2)

p <- 
  ggplot(aggregated, aes(Cells_AreaShape_Area, Nuclei_AreaShape_Area)) + 
  geom_hex()

print(p)
```

